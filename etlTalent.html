<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>DE.BBMRI.FHIR\Etl Talent - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link rel="stylesheet" href="fhir.css"/>

      <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.css"/>
    <link rel="stylesheet" href="assets/css/bootstrap-fhir.css"/>

      <!-- Project extras -->
    <link rel="stylesheet" href="assets/css/project.css"/>
    <link rel="stylesheet" href="assets/css/pygments-manni.css"/>
    <link rel="stylesheet" href="assets/css/jquery-ui.css"/>
  	<link rel="stylesheet" href="assets/css/prism.css"/>
      <!-- Placeholder for child template CSS declarations -->
<link rel="stylesheet" href="assets/css/bbmri.de.css"/>

    <script src="fhir-table-scripts.js" type="text/javascript"> </script>

      <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
      <!-- [if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif] -->

      <!-- Favicons -->
    <link sizes="144x144" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link sizes="114x114" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link sizes="72x72" rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"8"}
    h3,h4,h5,h6{--heading-prefix:"8"}</style>
    <div id="segment-header" class="segment">    <!-- segment-header -->
      <div class="container">    <!-- container -->
          <!-- Placeholder for child template header declarations -->

	<div id="gba-nav">
	  <a no-external="true" id="gba-logo" href="http://www.bbmri.de">
	    <img src="assets/images/GBN_CMYK_schwarz.png" alt="GBA Logo" height="80"/>
	  </a>
	</div>
	<div id="buffer">
	</div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">BBMRI.de/GBA Implementation Guide</span><br/>1.2.0 - CI Build</p>
        </div>
      </div>   <!-- /container -->
    </div>    <!-- /segment-header -->

    <div id="segment-navbar" class="segment">    <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">    <!-- container -->
          <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
            <!-- status-bar -->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a href="http://hl7.org/fhir/R4/index.html" class="navbar-brand hidden">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
                <!-- menu.xml -->

<ul class="nav navbar-nav">
  <li>
    <a href="index.html">IG Home</a>
  </li>
  <li>
    <a href="toc.html">Table of Contents</a>
  </li>
  <li>
    <a href="artifacts.html">Artifact Index</a>
  </li>
  <li>
    <a href="overview.html">Profile Overview</a>
  </li>
  <li>
    <a href="howtoJoin.html">How to Join the Sample Locator</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Background
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="background.html">Overview</a>
      </li>
      <li>
        <a href="mappings.html">Mappings</a>
      </li>
      <li>
        <a href="referencedIGs.html">Referenced IGs</a>
      </li>
      <li>
        <a href="etlTalent.html">Build ETL with TOS</a>
      </li>
      <li>
        <a href="qualityMeasures.html">Quality Measures</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Support
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="support.html">Instructions</a>
      </li>
      <li>
        <a href="downloads.html">Downloads</a>
      </li>
      <li>
        <a href="http://hl7.org/fhir/R4/index.html" target="_blank">FHIR Spec <img src="external.png" style="text-align: baseline"/></a>
      </li>
    </ul>
  </li>
</ul>
            </div>    <!-- /.nav-collapse -->
          </div>    <!-- /.container -->
        </nav>    <!-- /.navbar -->
        <!-- /HEADER CONTENT -->
      </div>    <!-- /container -->
    </div>    <!-- /segment-navbar -->
      <!-- status-bar -->
    <div id="segment-breadcrumb" class="segment">    <!-- segment-breadcrumb -->
      <div class="container">    <!-- container -->
        <ul class="breadcrumb">
          <li><a href="toc.html"><b>Table of Contents</b></a></li><li><b>Etl Talent</b></li>
        </ul>
      </div>    <!-- /container -->
    </div>    <!-- /segment-breadcrumb -->

    <div id="segment-content">    <!-- segment-content -->
      <div class="container">    <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
    <!-- ReleaseHeader --><p id="publish-box">BBMRI.de/GBA Implementation Guide - Local Development build (v1.2.0). See the <a href="https://fhir.bbmri.de/history.html">Directory of published versions</a></p>  <!-- EndReleaseHeader -->
  <h2>Etl Talent</h2>
  









    <p>  <!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#step-by-step-instructions" id="markdown-toc-step-by-step-instructions">Step-by-step instructions:</a></li>
  <li><a href="#in-details" id="markdown-toc-in-details">In details:</a></li>
  <li><a href="#upload-bundles" id="markdown-toc-upload-bundles">Upload bundles:</a></li>
  <li><a href="#appendix" id="markdown-toc-appendix">Appendix:</a></li>
</ul>

</div>
  <!-- etlTalent.md -->
<p>This section describes how to build an ETL-process and fill the Blaze Store with Talend Open Studio for Data Integration and Hapi FHIR Api. This instructions were <a href="https://wiki.verbis.dkfz.de/pages/viewpage.action?pageId=76351392">originally</a> writen and tested by Marko Wegehaupt from Wuerzburg in november 2019.</p>

<h3 id="step-by-step-instructions">Step-by-step instructions:</h3>
<ol>
  <li>
    <p>A new routine must be created in <a href="https://www.talend.com/products/talend-open-studio/">Talend Open Studio for Data Integration</a>. In this manual it is called FHIR_API_Wrapper. click on „Edit libraries of the Routines“ and import the following libraries from <a href="https://github.com/jamesagnew/hapi-fhir/releases">hapi-fhir-4.0.0-standard-distribution</a> to solve imports.
<img src="TOS_FHIR_01_libraries.png" alt="TOS import external libs" title="Import external libs in TOS"/></p>
  </li>
  <li>Use JavaRow to create a FHIR_API_Wrapper Object in TOS and run methodes on it to produce FHIR Resources.</li>
  <li>In a final step upload the generated Bundles to the Blaze Store.</li>
</ol>

<h3 id="in-details">In details:</h3>

<h4 id="create-a-new-wrapper-object-in-a-java_row-componente-and-store-it-in-the-globalmap">Create a new wrapper-object in a Java_Row componente and store it in the globalMap:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Boolean returnCode;
FHIR_API_Wrapper temp;
globalMap.put("FHIR", temp=new FHIR_API_Wrapper());
</code></pre></div></div>

<h4 id="you-can-use-the-object-in-other-java-row-components-to-run-methodes">You can use the object in other Java-Row components to run methodes:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>returnCode = ((FHIR_API_Wrapper) globalMap.get("FHIR")).doPatient(toJava1.cPatId, toJava1.cBirthDate, toJava1.cDeceased, toJava1.cGender, toJava1.sourceFlag, toJava1.lastRowFlag);
or
returnCode = ((FHIR_API_Wrapper) globalMap.get("FHIR")).addEncounterToPatient(patFall.cPatId, patFall.FallNr, patFall.RecId,patFall.anfang, patFall.ende, "p70");
</code></pre></div></div>

<h4 id="create-a-new-bundle-in-the-tos-routine">Create a new Bundle in the TOS Routine:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle = new Bundle();
bundleCounter++;
bundle.setType(Bundle.BundleType.TRANSACTION);
bundle.setId(String.valueOf(bundleCounter));
bdlMap.put(String.valueOf(bundleCounter), bundle);
</code></pre></div></div>

<h4 id="create-patient-and-placing-the-patient-in-the-bundle">Create patient and placing the patient in the bundle:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Patient patient = new Patient();
IdDt patRand=IdDt.newRandomUuid();
patient.setId(cPatId); // argument from method call
patientRandMap.put(cPatId,patRand.getValueAsString());
patientCounter++;

Meta m= new Meta();
m.addProfile("https://fhir.bbmri.de/StructureDefinition/Patient");
patient.setMeta(m);

switch (geschlecht){
case "male": patient.setGender(AdministrativeGender.MALE); break;
case "female": patient.setGender(AdministrativeGender.FEMALE); break;
default: patient.setGender(AdministrativeGender.UNKNOWN);
}

patient.setId(cPatId);

if(geburtsDatum!=null)
  patient.setBirthDate(geburtsDatum);

if(sterbeDatum!=null)
  patient.setDeceased(new DateTimeType(sterbeDatum));

patientMap.put(patient.getId(),patient);
System.err.println("size after addition: "+patientMap.size());

bundle.addEntry()
   .setFullUrl(patRand.getValueAsString())
   .setResource(patient)
   .getRequest()
   .setUrl("Patient/"+patient.getId())
   .setMethod(HTTPVerb.PUT);

patientToBundle.put(patient.getId(), bundle.getId());
</code></pre></div></div>

<h4 id="create-and-assign-the-diagnosis-ressources">Create and assign the diagnosis ressources:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Condition condition = new Condition();
condition
   .getCode()
   .addCoding()
   .setSystem("http://fhir.de/CodeSystem/dimdi/icd-10-gm")
   .setVersion("2016")
   .setCode(code)
   .setDisplay(display.trim());
condition.setId(recId);
if(obEncId!=null)
  condition.setEncounter(new Reference("Encounter/fn"+obEncId));
if(onset!=null)
  condition.setOnset(new DateTimeType(onset));
if(abatement!=null)
  condition.setAbatement(new DateTimeType(abatement));
condition.getClinicalStatus()
   .addCoding()
   .setSystem("http://terminology.hl7.org/CodeSystem/condition-clinical")
   .setCode("resolved");

condition.setSubject(new Reference("Patient/"+patientMap.get(obPatId).getId()));

Bundle lookedUpBundle=bdlMap.get(patientToBundle.get(obPatId));

lookedUpBundle.addEntry()
   .setResource(condition)
   .setFullUrl(IdDt.newRandomUuid().getValueAsString())
   .getRequest()
   .setUrl("Condition/"+condition.getId())
   .setMethod(HTTPVerb.PUT);

System.err.println("condition added.");
</code></pre></div></div>

<h3 id="upload-bundles">Upload bundles:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FhirContext ctx = FhirContext.forR4();

// Create a client and PUT the transaction to the server
IGenericClient client = ctx.newRestfulGenericClient("http://FHIRSERVER:8080/fhir");

// Create an HTTP basic auth interceptor
String username = "admin";
String password = "psw";
IClientInterceptor authInterceptor = new BasicAuthInterceptor(username, password);
client.registerInterceptor(authInterceptor);

System.err.println("number of bundles: "+bdlMap.size());
for (Bundle bdlIt : bdlMap.values()) {
  System.out.println(ctx.newJsonParser().setPrettyPrint(true).encodeResourceToString(bdlIt));
  Bundle resp = client.transaction().withBundle(bdlIt).execute();
  System.out.println(ctx.newJsonParser().setPrettyPrint(true).encodeResourceToString(resp));
}
</code></pre></div></div>

<p><img src="TOS_FHIR_02_Flow1.png" alt="TOS Flow1"/></p>

<p><img src="TOS_FHIR_03_Flow2.png" alt="TOS Flow2"/></p>

<h3 id="appendix">Appendix:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@ResourceDef(name="Specimen", profile="https://fhir.bbmri.de/StructureDefinition/Specimen")

public class GBASpecimen extends Specimen {

private static final long serialVersionUID = 1L;

/**
* Each extension is defined in a field. Any valid HAPI Data Type
* can be used for the field type. Note that the [name=""] attribute
* in the @Child annotation needs to match the name for the bean accessor
* and mutator methods.
*/
@Child(name="temperatureCC")
@Extension(url="https://fhir.bbmri.de/StructureDefinition/StorageTemperature", definedLocally=true, isModifier=false)
@Description(shortDefinition="The temperature")
private CodeableConcept myTemperatureCC;
@Child(name="orgaRef")
@Extension(url="https://fhir.bbmri.de/StructureDefinition/Custodian", definedLocally=true, isModifier=false)
@Description(shortDefinition="The custodian")
private Reference myOrgaRef;
@Child(name="diagnoseCC")
@Extension(url="https://fhir.bbmri.de/StructureDefinition/SampleDiagnosis", definedLocally=true, isModifier=false)
@Description(shortDefinition="SampleDiagnosis")
private CodeableConcept mySampleDiagnosisCC;
@Child(name="typeIBDWCC")
@Extension(url="http://ibdw.de/fhir/StructureDefinition/SampleType", definedLocally=true, isModifier=false)
@Description(shortDefinition="SampleType")
private CodeableConcept myTypeIBDWCC;


/**
* It is important to override the isEmpty() method, adding a check for any
* newly added fields.
*/
@Override
public boolean isEmpty() {
   return super.isEmpty()
   &amp;&amp; ElementUtil.isEmpty(myTemperatureCC)
   &amp;&amp; ElementUtil.isEmpty(myOrgaRef)
   &amp;&amp; ElementUtil.isEmpty(mySampleDiagnosisCC)
   &amp;&amp; ElementUtil.isEmpty(myTypeIBDWCC);
}

/********
* Accessors and mutators follow
*
* IMPORTANT:
* Each extension is required to have an getter/accessor and a setter/mutator.
* You are highly recommended to create getters which create instances if they
* do not already exist, since this is how the rest of the HAPI FHIR API works.
********/


/** Getter for CC */
public CodeableConcept getTemperatureCC() {
if (myTemperatureCC == null) {
  myTemperatureCC = new CodeableConcept();
}
return this.myTemperatureCC;
}

public CodeableConcept getSampleDiagnosisCC() {
if (mySampleDiagnosisCC == null) {
  mySampleDiagnosisCC = new CodeableConcept();
}
return this.mySampleDiagnosisCC;
}

public CodeableConcept getTypeIBDWCC() {
if (myTypeIBDWCC == null) {
  myTypeIBDWCC = new CodeableConcept();
}
return this.myTypeIBDWCC;
}

public Reference getOrgaRef() {
if (myOrgaRef == null) {
  myOrgaRef = new Reference();
}
return this.myOrgaRef;
}

@Override
public ResourceType getResourceType(){
return ResourceType.Specimen;

}

@Override
public FhirVersionEnum getStructureFhirVersionEnum() {
return FhirVersionEnum.R4;
}
}
</code></pre></div></div>



</div>
        </div>    <!-- /inner-wrapper -->
      </div>    <!-- /row -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-content -->

  <script src="assets/js/jquery.js" type="text/javascript"> </script>       <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script src="assets/js/jquery-ui.min.js" type="text/javascript"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <div igtool="footer" id="segment-footer" class="segment">    <!-- segment-footer -->
    <div class="container">    <!-- container -->
      <div class="inner-wrapper">
        <p><a name="854a99d8-298f-4f44-a4b4-7979a57313a4">​</a>
          IG &copy; 2020+ <a style="color: #81BEF7" href="bbmri.de">bbmri.de</a>.  Package de.bbmri.fhir#1.2.0 based on <a style="color: #81BEF7" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Wed, Mar 3, 2021 08:01+0000">2021-03-03</span>
          <br/>
          <span style="color: #FFFF77">
                      Links: <a style="color: #81BEF7" href="toc.html">Table of Contents</a> |
                 <a style="color: #81BEF7" href="qa.html">QA Report</a>
| <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" alt="Creative Commons Lizenzvertrag" style="border-width:0"/></a>
          </span>
        </p>
      </div>    <!-- /inner-wrapper -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">    <!-- segment-post-footer -->
    <div class="container">    <!-- container -->
    </div>    <!-- /container -->
  </div>    <!-- /segment-post-footer -->
  
    <!-- JS and analytics only. -->
    <!-- Bootstrap core JavaScript
  ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
  <script src="assets/js/bootstrap.min.js" type="text/javascript"> </script>
  <script src="assets/js/respond.min.js" type="text/javascript"> </script>
  <script src="assets/js/anchor.min.js" type="text/javascript"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
    <!-- Analytics Below
  ================================================== -->
  </body>
</html>